@*@page "/ziren/provincia/{marcaID:int}/{anoID:int}/{modeloID:int}"*@
@page "/ziren/provincia"
@inject IRepositorio repositorio
@inject IMostrarMensajes mostrarMensajes
@inject NavigationManager navigationManager

@inject IJSRuntime JsRuntime
@using System.Text.Json;

<h3 style="color:white">Seleccione la Provincia</h3>
<label style="color:white;font-size: 0.8em;align-content:initial">Declarar la provincia correcta ya que afecta al costo de tu seguro, para tener una cotización correcta 🤗</label>
@if (oProvinciasList == null)
{
    <Cargando></Cargando>
}
else
{
    @if (oProvinciasAuxList.Count == 0)
    {
        <text>No hay registros para mostrar</text>
    }
    else
    {
        <div style="margin-right: 2%; margin-bottom: 10px; text-align: center;">
            <input @bind-value="oProvinciaDescripcion" @bind-value:event="oninput"
                   @onkeyup="@((KeyboardEventArgs e) => ProvinciaKeyUp(e))"
                   type="text" class="form-control" id="titulo" placeholder="Provincia" />
        </div>
        <div style="display: flex; flex-wrap: wrap; align-items: center;">
            @foreach (var oProvincias in oProvinciasAuxList)
            {
                <div style="margin-right: 2%; margin-bottom: 10px; text-align: center;">
                    <div>
                        @*<a href="/ziren/CotizacionRapida/@marcaID/@anoID/130108/@oProvincias.Key" class="btn btn-success" style="width:200px"> @oProvincias.Value</a>*@
                        <button type="button" class="btn btn-success" style="width:auto" @onclick="@(() => OnClickHandle(@oProvincias.provinciaID))">
                            @oProvincias.descripcion
                        </button>
                    </div>
                </div>
            }
        </div>
    }
}
@if (partnerWhatsapp == string.Empty)
{
    <Cargando></Cargando>
}
else
{
    partner.Celular1 = "54" + partner.Celular1;
    <a href="https://wa.me/@partner.Celular1?text=@partner.Whatsapp" title="Chat with Us" class="whatsapp" target="_blank" style="position: fixed; top: 500px; right: 30px; z-index: 99">
        <img src="../images/whatsapp.png" style="margin-top:0px;margin-left:0px" height="48" width="48" />
    </a>
}
@code {

    Partner partner = new Partner();
    private string partnerWhatsapp = string.Empty;
    string oProvinciaDescripcion = "";

    private List<ProvinciaDTO> oProvinciasList;
    private List<ProvinciaDTO> oProvinciasAuxList;
    protected override async Task OnInitializedAsync()
    {
        var responseHttp = await repositorio.Get<List<ProvinciaDTO>>("api/Externo/Prudencia/catalogos/GetProvincias");
        oProvinciasList = responseHttp.Response;
        oProvinciasAuxList = responseHttp.Response;

        #region GetFromLocalStoragePartner
        string partnerJson = await JsRuntime.GetFromLocalStorage("partner");
        partner = JsonSerializer.Deserialize<Partner>(partnerJson);
        partnerWhatsapp = partner.Whatsapp;
        #endregion

    }
    private async Task ProvinciaKeyUp(KeyboardEventArgs e)
    {

        oProvinciasAuxList = (from c in oProvinciasList
                              where c.descripcion.ToLower().Contains(oProvinciaDescripcion.ToLower())
                              select c).ToList();




    }
    private async Task OnClickHandle(string oprovinciasID)
    {
        //Singleton.oCotizacionAutoDTO.asegurado.provinciaID = oprovinciasID;

        string CotizacionAutoDTOJson = await JsRuntime.GetFromLocalStorage("CotizacionAutoDTO");
        CotizacionAutoDTO oCotizacionAutoDTO = JsonSerializer.Deserialize<CotizacionAutoDTO>(CotizacionAutoDTOJson);

        oCotizacionAutoDTO.asegurado.provinciaID = oprovinciasID;

        CotizacionAutoDTOJson = JsonSerializer.Serialize(oCotizacionAutoDTO);
        await JsRuntime.SetInLocalStorage("CotizacionAutoDTO", CotizacionAutoDTOJson);
        Console.WriteLine(CotizacionAutoDTOJson);


        #region CotizacionEntitiesDTO
        string cotizacionEntitiesDTOJson = await JsRuntime.GetFromLocalStorage("CotizacionEntitiesDTO");
        CotizacionEntitiesDTO cotizacionEntitiesDTO = JsonSerializer.Deserialize<CotizacionEntitiesDTO>(cotizacionEntitiesDTOJson);



        ProvinciaDTO oProvincias = (from c in oProvinciasList
                                    where c.provinciaID == oprovinciasID
                                    select c).FirstOrDefault();

        cotizacionEntitiesDTO.provincia = oProvincias;

        cotizacionEntitiesDTOJson = JsonSerializer.Serialize(cotizacionEntitiesDTO);
        await JsRuntime.SetInLocalStorage("CotizacionEntitiesDTO", cotizacionEntitiesDTOJson);
        Console.WriteLine(cotizacionEntitiesDTOJson);
        #endregion


        navigationManager.NavigateTo("/ziren/cp");
    }
}
